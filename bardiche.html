<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<script src="pixi.js"></script>
	<title>Bardiche</title>
</head>
	
<body style="background-color: #d95763;">

<div id="wrapper" style="display: flex; height: 100vh; justify-content: center; align-items: center;">
<div id="container" style="display: inline-block; width: 512px; height: 512px; margin-left: auto; margin-right: auto; border: thick solid #ac3232;"></div>
</div>
	<script type="text/javascript" src="keyboard.js"></script>
	<script type="text/javascript" src="collision.js"></script>

	<script type="text/javascript" src="player.js"></script>
	<script type="text/javascript" src="enemies.js"></script>
	<script type="text/javascript" src="levels.js"></script>

	<script type="text/javascript">

		// Aliases
		let Container = PIXI.Container,
			autoDetectRenderer = PIXI.autoDetectRenderer,
			loader = PIXI.loader,
			resources = PIXI.loader.resources,
			Sprite = PIXI.Sprite,
			Text = PIXI.Text;

		// Pixi.js settings
		PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;

		// Create the rendering environment and attach it to the page
		let stage = new Container(),   
			renderer = autoDetectRenderer(512, 512, {antialias: false});
		renderer.backgroundColor = 0x639BFF;
		document.getElementById("container").appendChild(renderer.view);
		
		// Load spritesheets
		loader.add("res/tiledata.json")
			.add("res/playerdata.json")
			.add("res/dummydata.json")
			.add("res/pumpkingdata.json")
			.add("res/nuttboydata.json")
			.add("res/background.png")
			.load(setup);

		// Set initial game state
		let state = play;
		let screen = 0;

		/*
		 *  setup
		 *
		 *  intitializes sprites, hitboxes, keyboard callbacks
		 */
		let activeScreen;
		let player;

		let tileGroup;
		let keyObjectLeft, keyObjectRight, keyObjectZ, keyObjectX;
		let groundBoxes, hitBoxRenderer;
		let renderHitboxes;
		let backgroundSprite;
		function setup() {

			let tileTextures = PIXI.loader.resources["res/tiledata.json"].textures;
			let playerTextures = PIXI.loader.resources["res/playerdata.json"].textures;
			let dummyTextures = PIXI.loader.resources["res/dummydata.json"].textures;
			let kingTextures = PIXI.loader.resources["res/pumpkingdata.json"].textures;

			activeScreen = {
				stage: undefined,
				enemies: []
			};

			hitBoxRenderer = new PIXI.Graphics();
			renderHitboxes = false;

			backgroundSprite = new Sprite(resources["res/background.png"].texture);

			player = spawnPlayer(buildPlayer(playerBase_pinkKnight), 32, 384);

			setActiveScreen(0);
			renderer.render(activeScreen.stage);

			keyObjectLeft = keyboard(37);
			keyObjectLeft.press = function() {
				player.sprite.scale.x = -1;
			}

			keyObjectRight = keyboard(39);
			keyObjectRight.press = function() {
				player.sprite.scale.x = 1;
			}

			keyObjectUp = keyboard(38);
			keyObjectUp.press = function() {   
				if (player.grounded) {
					player.grounded = false;
					player.sprite.vy = -5;
				}
			}

			keyObjectZ = keyboard(90);
			keyObjectZ.press = function() {
				setAnimation(player.sprite, player.animations.stab, true);
				player.sprite.animationSpeed = 0.05;

				player.weaponbox = [{
					offsetX: 12,
					offsetY: 0,

					width: 28,
					height: 12
				}, {  
					offsetX: 22,
					offsetY: 0,

					width: 28,
					height: 12,
				}]
			}
			keyObjectZ.release = function() {
				player.sprite.loop = false;
				player.sprite.onComplete = function() {
					setAnimation(player.sprite, player.animations.idle);
					player.sprite.animationSpeed = 0.1;
					player.weaponbox = 0;
				}
			}

			keyObjectX = keyboard(88);
			keyObjectX.press = function() {
				setAnimation(player.sprite, player.animations.slash, true);
				player.sprite.animationSpeed = 0.05;

				player.weaponbox = [{
					offsetX: 14,
					offsetY: -34,

					width: 14,
					height: 22
				}, {
					offsetX: 22,
					offsetY: 2,

					width: 28,
					height: 12,
				}]
			}
			keyObjectX.release = function() {
				player.sprite.loop = false;
				player.sprite.onComplete = function() {
					setAnimation(player.sprite, player.animations.idle);
					player.sprite.animationSpeed = 0.1;
					player.weaponbox = 0;
				}
			}

			eventBoxes.forEach(function(set) {
				set.forEach(function(box) {
					buildHitbox(box);
				});
			});
		}

		setAnimation = function(actor, frames, loop=true) {
			if (actor.textures != frames) {
				actor.textures = frames;
				actor.gotoAndPlay(0);
				actor.updateTexture();
			} 

			actor.loop = loop;
		}

		moveActor = function(actor, dx, dy) {
			actor.hitbox.centerX += dx;
			actor.hitbox.centerY += dy;

			actor.sprite.x += dx;
			actor.sprite.y += dy;
		}

		animatePlayer = function() {
			if (player.weaponbox) {

			} else {
				if (player.grounded) {
					if (player.sprite.vx === 0) setAnimation(player.sprite, player.animations.idle);
					else setAnimation(player.sprite, player.animations.walk);
				} else {
					setAnimation(player.sprite, player.animations.jump);
				}
			}
		}

		controlPlayer = function() {
			if (player.grounded && player.weaponbox) {
				player.sprite.vx = 0;
			} else {
				if (keyObjectRight.isDown && !keyObjectLeft.isDown) {
					player.sprite.vx = 2;
				} else if (keyObjectLeft.isDown && !keyObjectRight.isDown) {
					player.sprite.vx = -2;
				} else {
					player.sprite.vx = 0
				}
			}
		}

		buildWeaponbox = function(actor, weaponboxBase) {
			let h = {
				x: actor.sprite.position.x + weaponboxBase.offsetX * actor.sprite.scale.x,
				y: actor.sprite.position.y + weaponboxBase.offsetY * actor.sprite.scale.y,

				width: weaponboxBase.width * actor.sprite.scale.x,
				height: weaponboxBase.height * actor.sprite.scale.y
			}

			buildHitbox(h);
			return h;
		}

		function buildStage(newScreen, enemies, playerSprite) {
			
			let tileTextures = PIXI.loader.resources["res/tiledata.json"].textures;
			let stage = new Container()

			groundBoxes = newScreen.groundBoxes;
			buildScreenBoxes(groundBoxes);
			
			stage.addChild(backgroundSprite);

			enemies.forEach(function(enemy) {
				stage.addChild(enemy.sprite);
			});

			stage.addChild(playerSprite);
			
			stage.addChild(getSpriteSet(tileTextures, newScreen.tiles));
			stage.addChild(hitBoxRenderer);

			return stage;
		}

		function setActiveScreen(key) {
			let enemiesSrc = screens[key].enemies;
			activeScreen.enemies = [];
			enemiesSrc.forEach(function(enemy) {
				activeScreen.enemies.push(spawnEnemy(buildEnemy(enemy.name), enemy.position.x, enemy.position.y));
			});

			activeScreen.stage = buildStage(screens[key], activeScreen.enemies, player.sprite);

		}

		function play() {
			hitBoxRenderer.clear();
			hitBoxRenderer.lineStyle(1, 0xFF0000);

			if (player.sprite.x < 0) {

				moveActor(player, 512, 0);
				screen--;
				
				setActiveScreen(screen);
			
			} else if (player.sprite.x > 512) {

				moveActor(player, -512, 0);
				screen++;

				setActiveScreen(screen);
			}

			player.grounded = false;
			moveActor(player, player.sprite.vx, player.sprite.vy);

			activeScreen.enemies.forEach(function(enemy) {
				enemy.grounded = false;
				moveActor(enemy, enemy.sprite.vx, enemy.sprite.vy);
			});

			let collisionList;
			if (collisionList = getCollisions(player.hitbox, groundBoxes)) {
				collisionList.forEach(function(collision) {
					resolveCollision(player, collision);
				});
			}

			if (!player.grounded) player.sprite.vy += 0.2;

			activeScreen.enemies.forEach(function(enemy) {
				if (collisionList = getCollisions(enemy.hitbox, groundBoxes)) {
					collisionList.forEach(function(collision) {
						resolveCollision(enemy, collision);
					});
				}

				if (!enemy.grounded) enemy.sprite.vy += 0.2;
				else enemy.sprite.vy = 0;
			});

			if (renderHitboxes) {
				groundBoxes.forEach(function(box) {
					hitBoxRenderer.drawRect(box.x, box.y, box.width, box.height);
				});

				drawHitbox(player.hitbox, hitBoxRenderer)
				if (player.weaponbox) {
					let box = buildWeaponbox(player, player.weaponbox[player.sprite.currentFrame]);
					hitBoxRenderer.drawRect(box.x, box.y, box.width, box.height);
				}

				activeScreen.enemies.forEach(function(enemy) {
					drawHitbox(enemy.hitbox, hitBoxRenderer);
				});
			}

			eventBoxes[screen].forEach(function(box) {
				let collision = rectangleCollision(player.hitbox, box);
				if (!box.playerPresent && collision) {
					box.onPlayerEnter();
				} else if (box.playerPresent && collision == undefined) {
					box.playerPresent = false;
				}

				if (renderHitboxes) hitBoxRenderer.drawRect(box.x, box.y, box.width, box.height);
			});

			controlPlayer();
			animatePlayer();
		}

		function gameLoop() {
			requestAnimationFrame(gameLoop);
			state();
			renderer.render(activeScreen.stage);
		}

		gameLoop();

	</script>
</body>
</html>
