<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<script src="pixi.js"></script>
	<title>Bardiche</title>
</head>
	
<body style="background-color: #d95763;">

<div id="wrapper" style="display: flex; height: 100vh; justify-content: center; align-items: center;">
<div id="container" style="display: inline-block; width: 512px; height: 512px; margin-left: auto; margin-right: auto; border: thick solid #ac3232;"></div>
</div>

	<script type="text/javascript" src="levels.js"></script>
	<script type="text/javascript" src="keyboard.js"></script>
	<script type="text/javascript" src="collision.js"></script>

	<script type="text/javascript">

		// Aliases
		let Container = PIXI.Container,
			autoDetectRenderer = PIXI.autoDetectRenderer,
			loader = PIXI.loader,
			resources = PIXI.loader.resources,
			Sprite = PIXI.Sprite,
			Text = PIXI.Text;

		// Pixi.js settings
		PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;

		// Create the rendering environment and attach it to the page
		let stage = new Container(),   
			renderer = autoDetectRenderer(512, 512, {antialias: false});
		renderer.backgroundColor = 0x639BFF;
		document.getElementById("container").appendChild(renderer.view);
		
		// Load spritesheets
		loader.add("res/tiledata.json")
			.add("res/playerdata.json")
			.add("res/dummydata.json")
			.add("res/pumpkingdata.json")
			.add("res/background.png")
			.load(setup);

		// Set initial game state
		let state = play;

		/*
		 *  buildAnimations
		 *
		 *  Builds animations from spritesheets.
		 */
		let playerSprite, dummySprite, bigdummySprite;
		let playerWalkFrames, playerIdleFrames, playerJumpFrames, playerStabFrames, playerSlashFrames;
		let dummyIdleFrames, dummyHitFrames;
		let kingSleepFrames, kingWakeFrames, kingIdleFrames;
		function buildAnimations() {

			// PLAYER

			playerWalkFrames = []; playerIdleFrames = []; playerJumpFrames = [];
			playerStabFrames = []; playerSlashFrames = [];

			playerWalkFrames.push(PIXI.Texture.fromFrame("pink-knight-walk-1.png"));
			playerWalkFrames.push(PIXI.Texture.fromFrame("pink-knight-walk-2.png"));

			playerIdleFrames.push(PIXI.Texture.fromFrame("pink-knight-stand.png"));
			playerIdleFrames.push(PIXI.Texture.fromFrame("pink-knight-stand.png"));

			playerJumpFrames.push(PIXI.Texture.fromFrame("pink-knight-walk-2.png"));
			playerJumpFrames.push(PIXI.Texture.fromFrame("pink-knight-walk-2.png"));

			playerStabFrames.push(PIXI.Texture.fromFrame("pink-knight-stab-1.png"));
			playerStabFrames.push(PIXI.Texture.fromFrame("pink-knight-stab-2.png"));

			playerSlashFrames.push(PIXI.Texture.fromFrame("pink-knight-slash-1.png"));
			playerSlashFrames.push(PIXI.Texture.fromFrame("pink-knight-slash-2.png"));


			// TRAINING DUMMY

			dummyIdleFrames = []; dummyHitFrames = [];

			dummyIdleFrames.push(PIXI.Texture.fromFrame("dummy-stand.png"));
			dummyIdleFrames.push(PIXI.Texture.fromFrame("dummy-stand.png"));

			dummyHitFrames.push(PIXI.Texture.fromFrame("dummy-hit-1.png"));
			dummyHitFrames.push(PIXI.Texture.fromFrame("dummy-hit-2.png"));

			// PUMPKING

			kingSleepFrames = []; kingWakeFrames = []; kingIdleFrames = [];

			kingSleepFrames.push(PIXI.Texture.fromFrame("pumpking-sleep"));

			kingWakeFrames.push(PIXI.Texture.fromFrame("pumpking-wake-1"));
			kingWakeFrames.push(PIXI.Texture.fromFrame("pumpking-wake-2"));
			kingWakeFrames.push(PIXI.Texture.fromFrame("pumpking-wake-3"));
			kingWakeFrames.push(PIXI.Texture.fromFrame("pumpking-wake-4"));
			kingWakeFrames.push(PIXI.Texture.fromFrame("pumpking-wake-5"));

			kingIdleFrames.push(PIXI.Texture.fromFrame("pumpking-drip-1"));
			kingIdleFrames.push(PIXI.Texture.fromFrame("pumpking-drip-2"));
			kingIdleFrames.push(PIXI.Texture.fromFrame("pumpking-drip-3"));
			kingIdleFrames.push(PIXI.Texture.fromFrame("pumpking-drip-4"));
		}

		/*
		 *  setup
		 *
		 *  intitializes sprites, hitboxes, keyboard callbacks
		 */
		let tileGroup;
		let keyObjectLeft, keyObjectRight, keyObjectZ, keyObjectX;
		let groundBoxes, hitBoxRenderer;
		let renderHitboxes;
		let backgroundSprite;
		function setup() {

			let tileTextures = PIXI.loader.resources["res/tiledata.json"].textures;
			let playerTextures = PIXI.loader.resources["res/playerdata.json"].textures;
			let dummyTextures = PIXI.loader.resources["res/dummydata.json"].textures;
			let kingTextures = PIXI.loader.resources["res/pumpkingdata.json"].textures;
			buildAnimations();

			hitBoxRenderer = new PIXI.Graphics();
			renderHitboxes = false;

			backgroundSprite = new Sprite(resources["res/background.png"].texture);

			bigdummySprite = new PIXI.extras.AnimatedSprite(kingIdleFrames);
			bigdummySprite.animationSpeed = 0.1;
			bigdummySprite.play();
			bigdummySprite.y = 160;
			bigdummySprite.x = 192;

			dummySprite = new PIXI.extras.AnimatedSprite(dummyIdleFrames);
			dummySprite.animationSpeed = 0.05;
			dummySprite.play();
			dummySprite.anchor.x = 0.5;
			dummySprite.x = 96;
			dummySprite.y = 324;

			dummySprite.hitbox = {
				x: dummySprite.x - dummySprite.width/6,
				y: dummySprite.y + dummySprite.height/4,
				width: dummySprite.width/3,
				height: dummySprite.height/2,

				halfWidth: dummySprite.width/6,
				halfHeight: dummySprite.height/4,
				centerX: dummySprite.x,
				centerY: dummySprite.y + dummySprite.height/2
			}

			playerSprite = new PIXI.extras.AnimatedSprite(playerIdleFrames);
			playerSprite.position.set(32, 320);
			playerSprite.grounded = false;
			playerSprite.centerX = playerSprite.x;
			playerSprite.centerY = playerSprite.y + playerSprite.height / 2;
			playerSprite.vx = 0;
			playerSprite.vy = 0;

			playerSprite.animationSpeed = 0.1;
			playerSprite.play();

			playerSprite.anchor.x = 0.5;

			playerSprite.hitbox = {x: playerSprite.x - 16,
								   y: playerSprite.y + 32,
								   width: 32,
								   height: 64};

			playerSprite.weaponbox = 0;

			stage = buildStage(screenTiles[0], screenBoxes[0], playerSprite, dummySprite);
			renderer.render(stage);

			keyObjectLeft = keyboard(37);
			keyObjectLeft.press = function() {
				playerSprite.scale.x = -1;
			}

			keyObjectRight = keyboard(39);
			keyObjectRight.press = function() {
				playerSprite.scale.x = 1;
			}

			keyObjectUp = keyboard(38);
			keyObjectUp.press = function() {   
				if (playerSprite.grounded) {
					playerSprite.grounded = false;
					playerSprite.vy = -5;
				}
			}

			keyObjectZ = keyboard(90);
			keyObjectZ.press = function() {
				setAnimation(playerSprite, playerStabFrames, true);
				playerSprite.animationSpeed = 0.05;

				playerSprite.weaponbox = [{
					offsetX: 6,
					offsetY: 72,

					width: 32,
					height: 16
				}, {
					offsetX: 20,
					offsetY: 72,

					width: 32,
					height: 16,
				}]
			}
			keyObjectZ.release = function() {
				playerSprite.loop = false;
				playerSprite.onComplete = function() {
					setAnimation(playerSprite, playerIdleFrames);
					playerSprite.animationSpeed = 0.1;
					playerSprite.weaponbox = 0;
				}
			}

			keyObjectX = keyboard(88);
			keyObjectX.press = function() {
				setAnimation(playerSprite, playerSlashFrames, true);
				playerSprite.animationSpeed = 0.05;

				playerSprite.weaponbox = [{
					offsetX: 14,
					offsetY: 32,

					width: 16,
					height: 32
				}, {
					offsetX: 20,
					offsetY: 72,

					width: 32,
					height: 16,
				}]
			}
			keyObjectX.release = function() {
				playerSprite.loop = false;
				playerSprite.onComplete = function() {
					setAnimation(playerSprite, playerIdleFrames);
					playerSprite.animationSpeed = 0.1;
					playerSprite.weaponbox = 0;
				}
			}
		}

		setAnimation = function(actor, frames, loop=true) {
			if (actor.textures != frames) {
				actor.textures = frames;
				actor.gotoAndPlay(0);
				actor.updateTexture();
			}

			actor.loop = loop;
		}

		moveActor = function(Actor, dx, dy) {
			Actor.x = Actor.x + dx;
			Actor.y = Actor.y + dy;
			Actor.centerX = Actor.centerX + dx;
			Actor.centerY = Actor.centerY + dy;

			if (Actor.hitbox) {
				Actor.hitbox.x = Actor.hitbox.x + dx;
				Actor.hitbox.y = Actor.hitbox.y + dy;
				Actor.hitbox.centerX = Actor.hitbox.centerX + dx;
				Actor.hitbox.centerY = Actor.hitbox.centerY + dy;
			}
		}

		animatePlayer = function() {
			if (playerSprite.weaponbox) {

			} else {
				if (playerSprite.grounded) {
					if (playerSprite.vx === 0) setAnimation(playerSprite, playerIdleFrames);
					else setAnimation(playerSprite, playerWalkFrames);
				} else {
					setAnimation(playerSprite, playerJumpFrames);
				}
			}
		}

		controlPlayer = function() {
			if (playerSprite.grounded && playerSprite.weaponbox) {
				playerSprite.vx = 0;
			} else {
				if (keyObjectRight.isDown && !keyObjectLeft.isDown) {
					playerSprite.vx = 2;
				} else if (keyObjectLeft.isDown && !keyObjectRight.isDown) {
					playerSprite.vx = -2;
				} else {
					playerSprite.vx = 0
				}
			}
		}

		buildWeaponbox = function(actor, weaponboxBase) {

			let h = {
				x: actor.x + weaponboxBase.offsetX * actor.scale.x,
				y: actor.y + weaponboxBase.offsetY * actor.scale.y,

				width: weaponboxBase.width * actor.scale.x,
				height: weaponboxBase.height * actor.scale.y
			}

			buildHitbox(h);

			return h;
		}

		function buildStage(newScreenTiles, newScreenBoxes, player, enemies=undefined) {
			let tileTextures = PIXI.loader.resources["res/tiledata.json"].textures;
			let stage = new Container()

			groundBoxes = newScreenBoxes;
			buildScreenBoxes(groundBoxes);

			buildHitbox(playerSprite.hitbox);
			
			stage.addChild(backgroundSprite);
			if (enemies) stage.addChild(enemies);
			stage.addChild(player);
			stage.addChild(getSpriteSet(tileTextures, newScreenTiles));
			stage.addChild(hitBoxRenderer);

			return stage;
		}

		function play() {
			hitBoxRenderer.clear();
			hitBoxRenderer.lineStyle(1, 0xFF0000);

			if (playerSprite.x < 0) {

				playerSprite.x += 512;
				playerSprite.hitbox.x += 512;
				
				stage = buildStage(screenTiles[0], screenBoxes[0], playerSprite, dummySprite)
			
			} else if (playerSprite.x > 512) {

				playerSprite.x -= 512;
				playerSprite.hitbox.x -= 512;

				stage = buildStage(screenTiles[1], screenBoxes[1], playerSprite, bigdummySprite);
			}

			playerSprite.grounded = false;
			moveActor(playerSprite, playerSprite.vx, playerSprite.vy);

			let collisionList;
			if (collisionList = getCollisions(playerSprite.hitbox, groundBoxes)) {
				collisionList.forEach(function(collision) {
					resolveCollision(playerSprite, collision);
				});
			}

			if (playerSprite.weaponbox) {
				let activeWeaponbox = buildWeaponbox(playerSprite, playerSprite.weaponbox[playerSprite.currentFrame]);
				if (collisionList = getCollisions(activeWeaponbox, [dummySprite.hitbox])) {
					setAnimation(dummySprite, dummyHitFrames);
					dummySprite.gotoAndPlay(1 - playerSprite.currentFrame);
					dummySprite.updateTexture();
				}
			} else {
				setAnimation(dummySprite, dummyIdleFrames)
			}

			if (renderHitboxes) {
				groundBoxes.forEach(function(box) {
					hitBoxRenderer.drawRect(box.x, box.y, box.width, box.height);
				});

				hitBoxRenderer.drawRect(playerSprite.hitbox.x, playerSprite.hitbox.y, playerSprite.hitbox.width, playerSprite.hitbox.height);
				if (playerSprite.weaponbox) {
					let box = buildWeaponbox(playerSprite, playerSprite.weaponbox[playerSprite.currentFrame]);
					hitBoxRenderer.drawRect(box.x, box.y, box.width, box.height);
				}
			}

			if (!playerSprite.grounded) playerSprite.vy += 0.2;

			controlPlayer();
			animatePlayer();
		}

		function gameLoop() {
			requestAnimationFrame(gameLoop);
			state();
			renderer.render(stage);
		}

		gameLoop();

	</script>
</body>
</html>
