<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Bardiche</title>
</head>
	<script src="pixi.js"></script>
	
<body style="background-color: #d95763;">

<div id="wrapper" style="display: flex; height: 100vh; justify-content: center; align-items: center;">
<div id="container" style="display: inline-block; width: 512px; height: 512px; margin-left: auto; margin-right: auto; border: thick solid #ac3232;"></div>
</div>

	<script src="keyboard.js"></script>
	<script src="collision.js"></script>
	<script src="levels.js"></script>
	<script type="text/javascript">

		//Aliases
		let Container = PIXI.Container,
			autoDetectRenderer = PIXI.autoDetectRenderer,
			loader = PIXI.loader,
			resources = PIXI.loader.resources,
			Sprite = PIXI.Sprite,
			Text = PIXI.Text;

		let tileSrc = screen_0;

		PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;

		let stage = new Container(),
			renderer = autoDetectRenderer(512, 512, {antialias: false});
		renderer.backgroundColor = 0x639BFF;
		document.getElementById("container").appendChild(renderer.view);
		
		loader.add("res/tiledata.json")
			.add("res/playerdata.json")
			.add("res/dummydata.json")
			.load(setup);

		let state = play;

		let tiles, tileGroup;
		let keyObjectLeft, keyObjectRight, keyObjectZ, keyObjectX;
		let groundBoxes, hitBoxRenderer;
		let playerWalkFrames, playerIdleFrames, playerJumpFrames, playerStabFrames, playerSlashFrames;
		let dummyIdleFrames, dummyHitFrames;
alert("main")

		function setup() {

			let tileTextures = PIXI.loader.resources["res/tiledata.json"].textures;
			let playerTextures = PIXI.loader.resources["res/playerdata.json"].textures;
			let dummyTextures = PIXI.loader.resources["res/dummydata.json"].textures;

			tiles = getSpriteSet(tileTextures, screen_0);

			groundBoxes = [{x: 0, y: 288, width: 352, height: 32},
						   {x: 352, y: 224, width: 160, height: 96},
						   {x: 96, y: 96, width: 192, height: 64}];

			for (let i=0; i<groundBoxes.length; i++) {
				let box = groundBoxes[i];

				box.halfWidth = box.width / 2;
				box.halfHeight = box.height / 2;
				box.centerX = box.x + box.halfWidth;
				box.centerY = box.y + box.halfHeight;
				
			}

			dummyIdleFrames = []
			dummyHitFrames = []

			dummyIdleFrames.push(PIXI.Texture.fromFrame("dummy-stand.png"));
			dummyIdleFrames.push(PIXI.Texture.fromFrame("dummy-stand.png"));

			dummyHitFrames.push(PIXI.Texture.fromFrame("dummy-hit-1.png"));
			dummyHitFrames.push(PIXI.Texture.fromFrame("dummy-hit-2.png"));

			dummySprite = new PIXI.extras.AnimatedSprite(dummyIdleFrames);
			dummySprite.animationSpeed = 0.05;
			dummySprite.play();
			dummySprite.anchor.x = 0.5;
			dummySprite.x = 96;
			dummySprite.y = 192;

			dummySprite.hitbox = {
				x: dummySprite.x - dummySprite.width/6,
				y: dummySprite.y + dummySprite.height/4,
				width: dummySprite.width/3,
				height: dummySprite.height/2,

				halfWidth: dummySprite.width/6,
				halfHeight: dummySprite.height/4,
				centerX: dummySprite.x,
				centerY: dummySprite.y + dummySprite.height/2
			}

			playerWalkFrames = []
			playerIdleFrames = []
			playerJumpFrames = []
			playerStabFrames = []
			playerSlashFrames = []

			playerWalkFrames.push(PIXI.Texture.fromFrame("pink-knight-walk-1.png"));
			playerWalkFrames.push(PIXI.Texture.fromFrame("pink-knight-walk-2.png"));

			playerIdleFrames.push(PIXI.Texture.fromFrame("pink-knight-stand.png"));
			playerIdleFrames.push(PIXI.Texture.fromFrame("pink-knight-stand.png"));

			playerJumpFrames.push(PIXI.Texture.fromFrame("pink-knight-walk-2.png"));
			playerJumpFrames.push(PIXI.Texture.fromFrame("pink-knight-walk-2.png"));

			playerStabFrames.push(PIXI.Texture.fromFrame("pink-knight-stab-1.png"));
			playerStabFrames.push(PIXI.Texture.fromFrame("pink-knight-stab-1.png"));
			playerStabFrames.push(PIXI.Texture.fromFrame("pink-knight-stab-2.png"));
			playerStabFrames.push(PIXI.Texture.fromFrame("pink-knight-stab-2.png"));

			playerSlashFrames.push(PIXI.Texture.fromFrame("pink-knight-slash-1.png"));
			playerSlashFrames.push(PIXI.Texture.fromFrame("pink-knight-slash-1.png"));
			playerSlashFrames.push(PIXI.Texture.fromFrame("pink-knight-slash-2.png"));
			playerSlashFrames.push(PIXI.Texture.fromFrame("pink-knight-slash-2.png"));

			playerSprite = new PIXI.extras.AnimatedSprite(playerWalkFrames);
			playerSprite.position.set(192, 100);
			playerSprite.grounded = false;
			playerSprite.centerX = playerSprite.x;
			playerSprite.centerY = playerSprite.y + playerSprite.height / 2;
			playerSprite.vx = 0;
			playerSprite.vy = 0;

			playerSprite.animationSpeed = 0.1;
			playerSprite.play();

			playerSprite.anchor.x = 0.5;

			playerSprite.hitbox = {x: playerSprite.x - 16,
								   y: playerSprite.y + 32,
								   width: 32,
								   height: 64,
								   halfWidth: 16,
								   halfHeight: 32
								   };

			playerSprite.hitbox.centerY = playerSprite.hitbox.y + playerSprite.hitbox.halfHeight;
			playerSprite.hitbox.centerX = playerSprite.x;

			playerSprite.weaponbox = 0;

			hitBoxRenderer = new PIXI.Graphics();
			
			stage.addChild(dummySprite);
			stage.addChild(playerSprite);
			stage.addChild(tileGroup);
			stage.addChild(hitBoxRenderer);
			renderer.render(stage);

			keyObjectRight = keyboard(39);

			keyObjectRight.press = function() {
				playerSprite.vx += 2;

				setPlayerAnimation(playerWalkFrames);
			}
			keyObjectRight.release = function() {
				if (playerSprite.vx === 2) playerSprite.vx = 0;
			}

			keyObjectLeft = keyboard(37);
			keyObjectLeft.press = function() {
				playerSprite.vx -= 2;

				setPlayerAnimation(playerWalkFrames);
			}
			keyObjectLeft.release = function() {
				if (playerSprite.vx === -2) playerSprite.vx = 0;
			}

			keyObjectUp = keyboard(38);
			keyObjectUp.press = function() {
				if (playerSprite.grounded) {
					playerSprite.grounded = false;
					playerSprite.vy = -5;
				}
			}

			keyObjectZ = keyboard(90);
			keyObjectZ.press = function() {
				setPlayerAnimation(playerStabFrames, true);

				playerSprite.weaponbox = [{
					offsetX: 6,
					offsetY: 72,

					width: 32,
					height: 16
				}, {
					offsetX: 20,
					offsetY: 72,

					width: 32,
					height: 16,
				}]
			}
			keyObjectZ.release = function() {
				playerSprite.loop = false;
				playerSprite.onComplete = function() {
					setPlayerAnimation(playerIdleFrames);
					playerSprite.weaponbox = 0;
				}
			}

			keyObjectX = keyboard(88);
			keyObjectX.press = function() {
				setPlayerAnimation(playerSlashFrames, true);

				playerSprite.weaponbox = [{
					offsetX: 14,
					offsetY: 32,

					width: 16,
					height: 32
				}, {
					offsetX: 20,
					offsetY: 72,

					width: 32,
					height: 16,
				}]
			}
			keyObjectX.release = function() {
				playerSprite.loop = false;
				playerSprite.onComplete = function() {
					setPlayerAnimation(playerIdleFrames);
					playerSprite.weaponbox = 0;
				}
			}
		}

		setPlayerAnimation = function(frames, loop=true) {
			if (playerSprite.textures != frames) {
				playerSprite.textures = frames;
				playerSprite.gotoAndPlay(0);
			}

			playerSprite.loop = loop;
		}

		resolveCollision = function(Actor, collision) {
			let side = collision.side, overlap = collision.overlap;

			if (side == "top") {
				moveActor(Actor, 0, overlap);

			} else if (side == "bottom") {
				moveActor(Actor, 0, overlap * -1);
				Actor.grounded = true;

			} else if (side == "left") {
				moveActor(Actor, overlap, 0);

			} else if (side == "right") {
				moveActor(Actor, overlap * -1, 0);
			} 
		}

		moveActor = function(Actor, dx, dy) {
			Actor.x = Actor.x + dx;
			Actor.y = Actor.y + dy;
			Actor.centerX = Actor.centerX + dx;
			Actor.centerY = Actor.centerY + dy;

			if (Actor.hitbox) {
				Actor.hitbox.x = Actor.hitbox.x + dx;
				Actor.hitbox.y = Actor.hitbox.y + dy;
				Actor.hitbox.centerX = Actor.hitbox.centerX + dx;
				Actor.hitbox.centerY = Actor.hitbox.centerY + dy;
			}
		}

		function play() {
			hitBoxRenderer.clear();
			hitBoxRenderer.lineStyle(1, 0xFF0000);

			playerSprite.grounded = false;
			moveActor(playerSprite, playerSprite.vx, playerSprite.vy);

			let collisionList;
			if (collisionList = getCollisions(playerSprite.hitbox, groundBoxes)) {
				collisionList.forEach(function(collision) {
					resolveCollision(playerSprite, collision);
				});
			}

			if (!playerSprite.grounded) playerSprite.vy += 0.2;

		}

		function gameLoop() {
			requestAnimationFrame(gameLoop);
			state();
			renderer.render(stage);
		}

		gameLoop();

	</script>
</body>
</html>
